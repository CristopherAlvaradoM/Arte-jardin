---
interface Props {
  phoneNumber: string;
  message: string;
}

const { phoneNumber, message } = Astro.props;
---

<nav
  id="main-navbar"
  class="fixed top-0 left-0 w-full p-4 text-white bg-transparent z-20 transition-all duration-300"
>
  <div class="container mx-auto flex justify-between items-center">
    <!-- Logo -->
    <a href="/">
      <img src="/logo-blanco.png" alt="Logo" class="size-24" />
    </a>

    <!-- Menú en desktop -->
    <ul class="hidden md:flex space-x-10">
      <li><a href="/nosotros" class="link-barra">Nosotros</a></li>
      <li><a href="/servicios" class="link-barra">Servicios</a></li>
      <li><a href="/proyectos" class="link-barra">Proyectos</a></li>
      <li><a href="/clientes" class="link-barra">Clientes</a></li>
      <li><a href="/blog" class="link-barra">Blog</a></li>
    </ul>

    <!-- Botón contacto (siempre visible) -->
    <button
      data-whatsapp-btn
      id="whatsapp-button-nav"
      class="hidden md:inline-block bg-green_tertiary text-lg font-medium text-white px-5 py-2 rounded-full transition-transform duration-300 ease-in-out hover:scale-105"
    >
      Contáctanos
    </button>

    <!-- Botón hamburguesa en móvil -->
    <button
      id="hamburger-btn"
      class="md:hidden text-white text-3xl focus:outline-none"
      aria-label="Abrir menú"
    >
      &#9776;
    </button>
  </div>

  <!-- Menú móvil de pantalla completa -->
  <div
    id="mobile-menu"
    class="fixed inset-0 z-40 bg-green_primary text-white flex flex-col
            h-dvh transform -translate-x-full transition-transform duration-300
            overflow-y-auto overscroll-contain"
  >
    <!-- Header con logo y botón cerrar -->
    <div class="flex justify-between items-center p-4">
      <img src="/ArteJardin LOGO SIN FONDO-14 1.png" alt="Logo" class="h-32" />
      <button
        id="close-btn"
        class="text-white text-3xl font-medium"
        aria-label="Cerrar menú"
      >
        <img src="/x.png" alt="cerrar ventana" />
      </button>
    </div>
    <h3 class="font-secondary space-y-6 px-6 mt-8 text-2xl font-medium">
      Menú
    </h3>

    <!-- Lista de enlaces -->
    <ul
      class="flex flex-col space-y-6 px-6 mt-8 text-2xl font-normal flex-grow"
    >
      <li><a href="/nosotros">Nosotros</a></li>
      <li><a href="/servicios">Servicios</a></li>
      <li><a href="/proyectos">Proyectos</a></li>
      <li><a href="/clientes">Clientes</a></li>
      <li><a href="/blog">Blog</a></li>
    </ul>

    <!-- Botón al fondo -->
    <div class="px-6 mb-10">
      <button
        data-whatsapp-btn
        id="whatsapp-button-nav"
        class="block w-full text-center bg-green_tertiary text-white px-4 py-3 rounded-full font-semibold text-xl"
      >
        Contáctanos
      </button>
    </div>
  </div>
</nav>

<script is:inline define:vars={{ phoneNumber, message }}>
  (() => {
    if (typeof window === "undefined") return;

    const navbar = document.getElementById("main-navbar");
    const mobileMenu = document.getElementById("mobile-menu");
    const hamburgerBtn = document.getElementById("hamburger-btn");
    const closeBtn = document.getElementById("close-btn");
    const whatsappBtns = document.querySelectorAll("[data-whatsapp-btn]");

    let menuOpen = false;
    let lastScrollY = window.scrollY;

    // Bloqueo de scroll del documento (iOS-friendly)
    const lockScroll = () => {
      const y = window.scrollY;
      document.body.dataset.scrollY = String(y);
      document.body.style.position = "fixed";
      document.body.style.top = `-${y}px`;
      document.body.style.left = "0";
      document.body.style.right = "0";
      document.body.style.width = "100%";
    };
    const unlockScroll = () => {
      const y = parseInt(document.body.dataset.scrollY || "0", 10);
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.left = "";
      document.body.style.right = "";
      document.body.style.width = "";
      window.scrollTo(0, y);
    };

    const openMenu = () => {
      mobileMenu?.classList.remove("-translate-x-full");
      lockScroll();
      menuOpen = true;
    };
    const closeMenu = () => {
      mobileMenu?.classList.add("-translate-x-full");
      unlockScroll();
      menuOpen = false;
    };

    hamburgerBtn?.addEventListener("click", openMenu);
    closeBtn?.addEventListener("click", closeMenu);

    const handleScroll = () => {
      if (menuOpen) return; // no toques navbar con menú abierto
      const currentScrollY = window.scrollY;

      // Ocultar/mostrar navbar
      if (currentScrollY > lastScrollY && currentScrollY > 50) {
        navbar?.classList.add("-translate-y-full");
      } else {
        navbar?.classList.remove("-translate-y-full");
      }

      // Fondo
      if (currentScrollY > 10) {
        navbar?.classList.remove("bg-transparent");
        navbar?.classList.add(
          "bg-black/30",
          "bg-opacity-80",
          "backdrop-blur-md"
        );
      } else {
        navbar?.classList.remove(
          "bg-black",
          "bg-opacity-80",
          "backdrop-blur-md"
        );
        navbar?.classList.add("bg-transparent");
      }

      lastScrollY = currentScrollY;
    };
    window.addEventListener("scroll", handleScroll);

    // WhatsApp (ambos botones)
    whatsappBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const isMobile =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          );
        const encodedMessage = encodeURIComponent(message);
        const url = isMobile
          ? `whatsapp://send?phone=${phoneNumber}&text=${encodedMessage}`
          : `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;
        window.open(url, "_blank");
      });
    });
  })();
</script>
